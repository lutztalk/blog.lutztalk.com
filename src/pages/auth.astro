---
// This page handles the GitHub OAuth callback for Decap CMS.
// Decap CMS will handle the OAuth flow automatically.
// We just need this page to exist and let the CMS process the callback.
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authenticating...</title>
</head>
<body>
  <div id="nc-root"></div>
  <script is:inline>
    // Suppress React errors - catch and ignore removeChild errors
    (function() {
      const originalRemoveChild = Node.prototype.removeChild;
      Node.prototype.removeChild = function(child) {
        try {
          return originalRemoveChild.call(this, child);
        } catch (e) {
          if (e instanceof Error && e.message && e.message.includes('not a child')) {
            return child;
          }
          throw e;
        }
      };
    })();
    
    // Load CMS script and initialize after it loads
    var script = document.createElement('script');
    script.src = 'https://unpkg.com/decap-cms@3.8.0/dist/decap-cms.js';
    script.onload = function() {
      // Wait a bit for CMS to be fully available
      setTimeout(function() {
        var root = document.getElementById('nc-root');
        if (root && typeof window.CMS !== 'undefined' && window.CMS) {
          // Show root
          root.style.display = 'block';
          // Initialize CMS - it will handle the OAuth callback automatically
          try {
            window.CMS.init();
            
            // If we're on the auth page with provider=github, try to trigger OAuth
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('provider') === 'github') {
              // Wait for CMS to render, then find and click the login button
              setTimeout(function() {
                var loginBtn = root.querySelector('button');
                if (loginBtn && loginBtn.textContent && loginBtn.textContent.includes('GitHub')) {
                  // Try clicking the button to trigger OAuth
                  loginBtn.click();
                } else {
                  // If button not found, try to trigger auth directly via CMS
                  if (window.CMS && window.CMS.get && window.CMS.get().backend) {
                    try {
                      window.CMS.get().backend.authenticate({ provider: 'github', scope: 'repo' });
                    } catch (e) {
                      console.log('Could not trigger auth automatically:', e);
                    }
                  }
                }
              }, 500);
            }
          } catch (e) {
            console.error('Error initializing CMS:', e);
          }
        }
      }, 100);
    };
    document.head.appendChild(script);
  </script>
</body>
</html>

