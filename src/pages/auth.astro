---
// This page handles the GitHub OAuth callback for Decap CMS.
// Decap CMS will handle the OAuth flow automatically.
// We just need this page to exist and let the CMS process the callback.
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authenticating...</title>
</head>
<body>
  <div id="nc-root"></div>
  <script is:inline>
    // Suppress React errors - catch and ignore removeChild errors
    (function() {
      const originalRemoveChild = Node.prototype.removeChild;
      Node.prototype.removeChild = function(child) {
        try {
          return originalRemoveChild.call(this, child);
        } catch (e) {
          if (e instanceof Error && e.message && e.message.includes('not a child')) {
            return child;
          }
          throw e;
        }
      };
    })();
    
    // Load CMS script and initialize after it loads
    var script = document.createElement('script');
    script.src = 'https://unpkg.com/decap-cms@3.8.0/dist/decap-cms.js';
    script.onload = function() {
      // Wait a bit for CMS to be fully available
      setTimeout(function() {
        var root = document.getElementById('nc-root');
        if (root && typeof window.CMS !== 'undefined' && window.CMS) {
          // Show root
          root.style.display = 'block';
          // Initialize CMS - it will handle the OAuth callback automatically
          try {
            window.CMS.init();
            
            // Check if we have a token from OAuth callback
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            var code = urlParams.get('code'); // OAuth callback code
            var provider = urlParams.get('provider');
            
            // If we have a token, the CMS should handle it automatically
            // Just let it initialize normally
            if (token && provider === 'github') {
              // Token is present, CMS should handle authentication
              // No action needed, just let CMS initialize
            } else if (!code && provider === 'github') {
              // Wait for CMS to fully render, then try multiple methods to trigger OAuth
              setTimeout(function() {
                // Method 1: Find and click the login button
                var buttons = root.querySelectorAll('button, a[role="button"]');
                for (var i = 0; i < buttons.length; i++) {
                  var btn = buttons[i];
                  var text = btn.textContent || btn.innerText || '';
                  if (text.toLowerCase().includes('github') || text.toLowerCase().includes('login')) {
                    btn.click();
                    return;
                  }
                }
                
                // Method 2: Try CMS API
                if (window.CMS && window.CMS.get) {
                  try {
                    var cms = window.CMS.get();
                    if (cms && cms.backend) {
                      // Try to trigger authentication
                      if (cms.backend.authenticate) {
                        cms.backend.authenticate();
                      } else if (cms.backend.login) {
                        cms.backend.login();
                      }
                    }
                  } catch (e) {
                    console.log('Could not trigger auth via CMS API:', e);
                  }
                }
              }, 1500);
            }
          } catch (e) {
            console.error('Error initializing CMS:', e);
          }
        }
      }, 100);
    };
    document.head.appendChild(script);
  </script>
</body>
</html>

