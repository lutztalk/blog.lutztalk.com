---
type Props = {
  email?: string;
};

const { email } = Astro.props;
---

<div
  id="subscribe-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
>
  <div
    class="relative bg-background border border-border rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
  >
    <button
      id="close-modal-btn"
      class="absolute top-4 right-4 text-foreground/60 hover:text-foreground focus:outline-none focus:ring-2 focus:ring-accent rounded"
      aria-label="Close modal"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 h-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>

    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900/20 mb-4">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6 text-green-600 dark:text-green-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M5 13l4 4L19 7"
          />
        </svg>
      </div>

      <h2
        id="modal-title"
        class="text-2xl font-bold text-foreground mb-2"
      >
        <span id="modal-title-text">Thanks for subscribing!</span>
      </h2>

      <p id="modal-message" class="text-foreground/80 mb-4">
        {email ? (
          <>
            We've sent a confirmation email to <strong id="modal-email">{email}</strong>. Check your inbox!
          </>
        ) : (
          <>
            Check your email for a confirmation message. We'll notify you whenever a new post is published.
          </>
        )}
      </p>

      <button
        id="modal-close-button"
        class="mt-4 px-6 py-2 rounded bg-accent text-background font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-opacity"
      >
        Got it!
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    function getModal() {
      return document.querySelector<HTMLDivElement>('#subscribe-modal');
    }

    function closeModal() {
      const modal = getModal();
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    function openModalInternal() {
      const modal = getModal();
      if (!modal) {
        console.warn('[SubscribeModal] Modal not found in DOM');
        return;
      }
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
      
      // Focus the close button for accessibility
      const closeButton = modal.querySelector<HTMLButtonElement>('#modal-close-button');
      if (closeButton) {
        closeButton.focus();
      }
    }

    function setupModal() {
      const modal = getModal();
      if (!modal) {
        console.warn('[SubscribeModal] Modal element not found');
        return;
      }

      const closeBtn = modal.querySelector<HTMLButtonElement>('#close-modal-btn');
      const closeButton = modal.querySelector<HTMLButtonElement>('#modal-close-button');

      // Close on button click
      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }
      if (closeButton) {
        closeButton.addEventListener('click', closeModal);
      }

      // Close on outside click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const currentModal = getModal();
          if (currentModal && !currentModal.classList.contains('hidden')) {
            closeModal();
          }
        }
      });
    }

    // Expose openModal globally so EmailSubscribe can call it
    function setupOpenModal() {
      (window as any).openSubscribeModal = (email?: string, isAlreadySubscribed = false) => {
        console.log('[SubscribeModal] openSubscribeModal called', { email, isAlreadySubscribed });
        // Re-query modal in case DOM changed (Astro view transitions)
        const modal = getModal();
        if (!modal) {
          console.warn('[SubscribeModal] Modal not found when trying to open');
          console.warn('[SubscribeModal] Available modals in DOM:', document.querySelectorAll('[id*="modal"]').length);
          return;
        }
        console.log('[SubscribeModal] Modal found, opening...');
        
        const titleEl = modal.querySelector('#modal-title-text');
        const messageEl = modal.querySelector('#modal-message');
        const emailEl = modal.querySelector('#modal-email') || modal.querySelector('strong');
        
        if (isAlreadySubscribed) {
          if (titleEl) titleEl.textContent = 'Already Subscribed!';
          if (messageEl) {
            if (email) {
              messageEl.innerHTML = `You're already subscribed with <strong>${email}</strong>. You'll receive notifications when new posts are published.`;
            } else {
              messageEl.textContent = "You're already subscribed! You'll receive notifications when new posts are published.";
            }
          }
        } else {
          if (titleEl) titleEl.textContent = 'Thanks for subscribing!';
          if (emailEl && email) {
            emailEl.textContent = email;
          }
          if (messageEl && email) {
            messageEl.innerHTML = `We've sent a confirmation email to <strong>${email}</strong>. Check your inbox!`;
          } else if (messageEl) {
            messageEl.textContent = "Check your email for a confirmation message. We'll notify you whenever a new post is published.";
          }
        }
        
        openModalInternal();
      };
    }
    
    // Setup immediately
    console.log('[SubscribeModal] Initializing modal...');
    setupModal();
    setupOpenModal();
    
    // Verify modal is in DOM
    const initialModal = getModal();
    if (initialModal) {
      console.log('[SubscribeModal] Modal found in DOM on init');
    } else {
      console.error('[SubscribeModal] Modal NOT found in DOM on init!');
    }
    
    // Test the global function is set
    if ((window as any).openSubscribeModal) {
      console.log('[SubscribeModal] openSubscribeModal function is available globally');
    } else {
      console.error('[SubscribeModal] openSubscribeModal function NOT available!');
    }
    
    // Re-setup on Astro view transitions
    document.addEventListener('astro:page-load', () => {
      console.log('[SubscribeModal] Astro page-load event, re-initializing...');
      setupModal();
      setupOpenModal();
    });
  })();
</script>
