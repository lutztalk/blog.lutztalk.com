---
type Props = {
  variant?: "inline" | "block";
  class?: string;
};

const { variant = "inline", class: className = "" } = Astro.props;
---

<div 
  class:list={[
    "email-subscribe",
    variant === "block" ? "flex flex-col gap-2" : "flex flex-col sm:flex-row gap-2",
    className
  ]}
>
  <form 
    id="email-subscribe-form"
    class:list={[
      "flex gap-2",
      variant === "block" ? "flex-col" : "flex-col sm:flex-row"
    ]}
  >
    <input
      type="email"
      id="email-input"
      name="email"
      placeholder="your@email.com"
      required
      class:list={[
        "px-4 py-2 rounded border border-border bg-background text-foreground",
        "focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent",
        "placeholder:text-muted",
        variant === "block" ? "w-full" : "flex-1 min-w-0"
      ]}
      aria-label="Email address"
    />
    <button
      type="submit"
      class:list={[
        "px-6 py-2 rounded bg-accent text-background font-medium",
        "hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2",
        "transition-opacity disabled:opacity-50 disabled:cursor-not-allowed",
        variant === "block" ? "w-full" : "whitespace-nowrap"
      ]}
      id="subscribe-button"
    >
      Subscribe
    </button>
  </form>
  <div id="subscribe-message" class="text-sm text-muted hidden"></div>
</div>

<!-- Subscribe Modal - will be added by pages that use this component -->

<script>
  (function() {
    const form = document.querySelector<HTMLFormElement>('#email-subscribe-form');
    const emailInput = document.querySelector<HTMLInputElement>('#email-input');
    const submitButton = document.querySelector<HTMLButtonElement>('#subscribe-button');
    const messageEl = document.querySelector<HTMLDivElement>('#subscribe-message');
    
    if (!form || !emailInput || !submitButton || !messageEl) return;

    function showMessage(text: string, isError = false) {
      if (!messageEl) return;
      messageEl.textContent = text;
      messageEl.classList.remove('hidden');
      messageEl.classList.remove('text-muted', 'text-green-600', 'text-red-600');
      messageEl.classList.add(isError ? 'text-red-600' : 'text-green-600');
      
      // Hide message after 5 seconds
      setTimeout(() => {
        if (messageEl) {
          messageEl.classList.add('hidden');
        }
      }, 5000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = emailInput.value.trim();
      if (!email) {
        showMessage('Please enter an email address', true);
        return;
      }

      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address', true);
        return;
      }

      // Disable button and show loading state
      submitButton.disabled = true;
      submitButton.textContent = 'Subscribing...';

      try {
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Subscription failed');
        }

        // Show modal for both success and already-subscribed cases
        // Wait a bit for modal to be ready (in case of view transitions)
        const openModal = (window as any).openSubscribeModal;
        if (openModal) {
          // Small delay to ensure modal is in DOM
          setTimeout(() => {
            openModal(email, data.alreadySubscribed);
          }, 100);
          emailInput.value = '';
        } else {
          console.warn('[EmailSubscribe] openSubscribeModal not found, using fallback message');
          // Fallback to inline message if modal not available
          if (data.alreadySubscribed) {
            showMessage('You\'re already subscribed!', false);
          } else {
            showMessage('Thanks for subscribing! Check your email to confirm.', false);
            emailInput.value = '';
          }
        }
      } catch (error) {
        console.error('Subscription error:', error);
        showMessage(
          error instanceof Error ? error.message : 'Something went wrong. Please try again.',
          true
        );
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Subscribe';
      }
    });
  })();
</script>

